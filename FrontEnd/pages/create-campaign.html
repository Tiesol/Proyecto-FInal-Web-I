<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="../assets/css/style.css" />
  <link rel="stylesheet" href="../assets/css/normalize.css" />
  <link rel="stylesheet" href="../assets/css/header.css" />
  <link rel="stylesheet" href="../assets/css/create-campaign.css" />
  <link rel="stylesheet" href="../assets/css/footer.css" />
  <link rel="stylesheet" href="../assets/fontsawesome/css/solid.min.css" />
  <link rel="stylesheet" href="../assets/fontsawesome/css/fontawesome.min.css" />
  <link rel="stylesheet" href="../assets/fontsawesome/css/brands.min.css" />
  <!-- Quill CSS -->
  <link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">
  <link rel="icon" href="../assets/images/riseup.svg" type="image/svg+xml">
  <title>Crear Campaña - RiseUp</title>
</head>

<body>
  <header>
    <div class="logo_container">
      <a href="./index-logged.html">
        <img src="./../assets/images/riseup.svg" alt="Logo RiseUp" />
      </a>
    </div>

    <div class="search_container">
      <form action="#" method="post">
        <input type="search" name="search" placeholder="Buscar..." />
        <button type="submit">
          <i class="fa-solid fa-magnifying-glass"></i>
        </button>
      </form>
      <div class="search_dropdown">
        <div class="search_dropdown_title">Categorías</div>
        <div class="search_categories_grid" id="searchCategoriesGrid"></div>
      </div>
    </div>

    <div class="user_menu_container">
      <input type="checkbox" id="userMenuToggle" class="user_menu_toggle">
      <label for="userMenuToggle" class="user_avatar_btn">
        <i class="fa-solid fa-user"></i>
      </label>
      <div class="user_dropdown">
        <a href="./my-campaigns.html" class="dropdown_item">
          <i class="fa-solid fa-bullhorn"></i>
          Mis Campañas
        </a>
        <a href="./favorites.html" class="dropdown_item">
          <i class="fa-solid fa-heart"></i>
          Favoritos
        </a>
        <a href="./donations.html" class="dropdown_item">
          <i class="fa-solid fa-hand-holding-dollar"></i>
          Mis Contribuciones
        </a>
        <a href="./profile.html" class="dropdown_item">
          <i class="fa-solid fa-user-circle"></i>
          Mi Perfil
        </a>
        <div class="dropdown_divider"></div>
        <a href="./admin.html" class="dropdown_item admin" id="adminLink" style="display: none;">
          <i class="fa-solid fa-shield"></i>
          Admin
        </a>
        <a href="#" class="dropdown_item logout" id="logoutBtn">
          <i class="fa-solid fa-right-from-bracket"></i>
          Cerrar Sesión
        </a>
      </div>
    </div>
  </header>

  <main class="create-campaign-page">
    <div class="campaign-container">
      <h1 class="page-title">Crear Nueva Campaña</h1>

      <!-- Mensaje de Error -->
      <div id="errorMessage" class="error-message" style="display: none;"></div>
      <div id="successMessage" class="success-message" style="display: none;"></div>

      <!-- Información Básica -->
      <section class="form-section">
        <h2>Información Básica</h2>
        
        <div class="form-group">
          <label for="campaignTitle">Título de la Campaña *</label>
          <input type="text" id="campaignTitle" placeholder="Ej: Ayuda para construir una escuela" required>
        </div>

        <div class="form-group">
          <label for="shortDescription">Descripción Corta *</label>
          <textarea id="shortDescription" rows="3" placeholder="Breve descripción de tu campaña (máx. 300 caracteres)" maxlength="300" required></textarea>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="categorySelect">Categoría *</label>
            <select id="categorySelect" required>
              <option value="">Selecciona una categoría</option>
            </select>
          </div>

          <div class="form-group">
            <label for="goalAmount">Meta de Financiación ($) *</label>
            <input type="number" id="goalAmount" placeholder="10000" min="1" required>
          </div>

          <div class="form-group">
            <label for="expirationDate">Fecha de Expiración *</label>
            <input type="date" id="expirationDate" required>
          </div>
        </div>

        <div class="form-group">
          <label for="mainImageUrl">URL de Imagen Principal</label>
          <input type="url" id="mainImageUrl" placeholder="https://ejemplo.com/imagen.jpg">
        </div>
      </section>

      <!-- Rewards / Recompensas -->
      <section class="form-section">
        <h2>Recompensas</h2>
        <p class="section-description">Añade recompensas para incentivar a los donadores.</p>

        <div id="rewardsList"></div>

        <div class="add-reward-form" id="addRewardForm">
          <div class="form-row">
            <div class="form-group">
              <label for="rewardTitle">Título de la Recompensa</label>
              <input type="text" id="rewardTitle" placeholder="Ej: Agradecimiento especial">
            </div>
            <div class="form-group">
              <label for="rewardMinAmount">Monto Mínimo ($)</label>
              <input type="number" id="rewardMinAmount" placeholder="50" min="1">
            </div>
          </div>
          <div class="form-group">
            <label for="rewardDescription">Descripción de la Recompensa</label>
            <textarea id="rewardDescription" rows="2" placeholder="Describe qué recibirá el donador"></textarea>
          </div>
          <button type="button" class="btn btn-add" id="btnAddReward">
            <i class="fa-solid fa-plus"></i> Añadir Recompensa
          </button>
        </div>
      </section>

      <!-- Descripción Completa -->
      <section class="form-section">
        <h2>Descripción Completa</h2>
        <p class="section-description">Cuenta la historia de tu campaña en detalle.</p>
        <div id="quillEditor"></div>
      </section>

      <!-- Modal para insertar imagen/video -->
      <div id="mediaModal" class="media-modal" style="display: none;">
        <div class="media-modal-content">
          <div class="media-modal-header">
            <h3 id="mediaModalTitle">Insertar Imagen</h3>
            <button type="button" class="media-modal-close" id="closeMediaModal">&times;</button>
          </div>
          <div class="media-modal-body">
            <div class="form-group">
              <label id="mediaModalLabel">URL de la imagen:</label>
              <input type="url" id="mediaUrlInput" placeholder="https://ejemplo.com/imagen.jpg">
            </div>
            <p id="mediaModalHelp" class="section-description"></p>
          </div>
          <div class="media-modal-footer">
            <button type="button" class="btn btn-cancel" id="cancelMediaBtn">Cancelar</button>
            <button type="button" class="btn btn-primary" id="insertMediaBtn">Insertar</button>
          </div>
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="campaign-actions">
        <div class="actions-left">
          <button type="button" class="btn btn-secondary" id="btnSave">
            <i class="fa-solid fa-save"></i> Guardar Cambios
          </button>
          <button type="button" class="btn btn-cancel" id="btnCancel">
            <i class="fa-solid fa-times"></i> Cancelar
          </button>
        </div>
        <div class="actions-right">
          <button type="button" class="btn btn-warning" id="btnObservations">
            <i class="fa-solid fa-eye"></i> Observaciones
          </button>
          <button type="button" class="btn btn-primary" id="btnSendCampaign">
            <i class="fa-solid fa-paper-plane"></i> Enviar Campaña
          </button>
        </div>
      </div>
    </div>
  </main>

  <footer class="site_footer">
    <div class="footer_container">
      <div class="footer_section footer_brand">
        <img src="./../assets/images/riseup.svg" alt="RiseUp Logo" class="footer_logo">
        <p class="footer_description">Conectando ideas innovadoras con personas que creen en ellas.</p>
        <div class="footer_social">
          <a href="#" class="social_link" aria-label="Instagram"><i class="fa-brands fa-instagram"></i></a>
          <a href="#" class="social_link" aria-label="X"><i class="fa-brands fa-x-twitter"></i></a>
          <a href="#" class="social_link" aria-label="Facebook"><i class="fa-brands fa-facebook"></i></a>
          <a href="#" class="social_link" aria-label="GitHub"><i class="fa-brands fa-github"></i></a>
        </div>
      </div>

      <div class="footer_section">
        <h3 class="footer_title">Legal</h3>
        <ul class="footer_links">
          <li><a href="#">Términos y condiciones</a></li>
          <li><a href="#">Política de privacidad</a></li>
        </ul>
      </div>

      <div class="footer_section">
        <h3 class="footer_title">Soporte</h3>
        <ul class="footer_links">
          <li><a href="#">Centro de ayuda</a></li>
          <li><a href="#">Guías para creadores</a></li>
          <li><a href="mailto:soporte@riseup.com">soporte@riseup.com</a></li>
        </ul>
      </div>
    </div>

    <div class="footer_bottom">
      <p>&copy; 2025 RiseUp. Todos los derechos reservados.</p>
    </div>
  </footer>
  
  <!-- Quill JS -->
  <script src="https://cdn.quilljs.com/1.3.7/quill.min.js"></script>
  <script src="../js/search-categories.js"></script>
  <script src="../js/header-user.js"></script>
  <script>
    const API_URL = 'http://localhost:3000';
    const rewards = [];
    let editingCampaignId = null;
    let currentMediaType = null;

    // Obtener ID de campaña si estamos editando
    function getCampaignId() {
      const params = new URLSearchParams(window.location.search);
      return params.get('id');
    }

    // Inicializar Quill con handler de imagen por URL
    const quill = new Quill('#quillEditor', {
      theme: 'snow',
      placeholder: 'Describe tu campaña en detalle...',
      modules: {
        toolbar: {
          container: [
            [{ 'header': [1, 2, 3, false] }],
            ['bold', 'italic', 'underline', 'strike'],
            [{ 'color': [] }, { 'background': [] }],
            [{ 'list': 'ordered'}, { 'list': 'bullet' }],
            [{ 'align': [] }],
            ['link', 'image', 'video'],
            ['clean']
          ],
          handlers: {
            image: imageHandler,
            video: videoHandler
          }
        }
      }
    });

    // Mostrar modal para media
    function showMediaModal(type) {
      currentMediaType = type;
      const modal = document.getElementById('mediaModal');
      const title = document.getElementById('mediaModalTitle');
      const label = document.getElementById('mediaModalLabel');
      const help = document.getElementById('mediaModalHelp');
      const input = document.getElementById('mediaUrlInput');

      if (type === 'image') {
        title.textContent = 'Insertar Imagen';
        label.textContent = 'URL de la imagen:';
        help.textContent = 'Pega la URL directa de la imagen (ej: https://ejemplo.com/foto.jpg)';
        input.placeholder = 'https://ejemplo.com/imagen.jpg';
      } else {
        title.textContent = 'Insertar Video';
        label.textContent = 'URL del video:';
        help.textContent = 'Pega el enlace de YouTube o Vimeo. Ej: https://youtube.com/watch?v=xxxxx';
        input.placeholder = 'https://youtube.com/watch?v=...';
      }

      input.value = '';
      modal.style.display = 'flex';
      input.focus();
    }

    // Cerrar modal
    function closeMediaModal() {
      document.getElementById('mediaModal').style.display = 'none';
      currentMediaType = null;
    }

    // Insertar media desde modal
    function insertMedia() {
      let url = document.getElementById('mediaUrlInput').value.trim();
      if (!url) {
        return;
      }

      const range = quill.getSelection(true);

      if (currentMediaType === 'video') {
        // Convertir URL de YouTube a embed
        if (url.includes('youtube.com/watch')) {
          const videoId = url.split('v=')[1]?.split('&')[0];
          if (videoId) url = `https://www.youtube.com/embed/${videoId}`;
        } else if (url.includes('youtu.be/')) {
          const videoId = url.split('youtu.be/')[1]?.split('?')[0];
          if (videoId) url = `https://www.youtube.com/embed/${videoId}`;
        }
        quill.insertEmbed(range.index, 'video', url);
      } else {
        quill.insertEmbed(range.index, 'image', url);
      }

      quill.setSelection(range.index + 1);
      closeMediaModal();
    }

    // Handler para insertar imagen
    function imageHandler() {
      showMediaModal('image');
    }

    // Handler para insertar video
    function videoHandler() {
      showMediaModal('video');
    }

    // Mostrar error visual
    function showError(message) {
      const errorDiv = document.getElementById('errorMessage');
      errorDiv.textContent = message;
      errorDiv.style.display = 'block';
      document.getElementById('successMessage').style.display = 'none';
      errorDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    // Mostrar éxito visual
    function showSuccess(message) {
      const successDiv = document.getElementById('successMessage');
      successDiv.textContent = message;
      successDiv.style.display = 'block';
      document.getElementById('errorMessage').style.display = 'none';
    }

    // Ocultar mensajes
    function hideMessages() {
      document.getElementById('errorMessage').style.display = 'none';
      document.getElementById('successMessage').style.display = 'none';
    }

    // Cargar categorías
    async function loadCategories() {
      try {
        const response = await fetch(`${API_URL}/categories/`);
        if (response.ok) {
          const categories = await response.json();
          const select = document.getElementById('categorySelect');
          categories.forEach(cat => {
            const option = document.createElement('option');
            option.value = cat.id;
            option.textContent = cat.name;
            select.appendChild(option);
          });
        }
      } catch (error) {
        console.error('Error cargando categorías:', error);
      }
    }

    // Cargar datos de campaña existente (modo edición)
    async function loadCampaignData(campaignId) {
      const token = localStorage.getItem('token');
      if (!token) return;

      try {
        const response = await fetch(`${API_URL}/campaigns/${campaignId}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (response.ok) {
          const campaign = await response.json();
          
          // Cambiar título de la página
          document.querySelector('.page-title').textContent = 'Editar Campaña';
          document.title = 'Editar Campaña - RiseUp';
          
          // Rellenar campos
          document.getElementById('campaignTitle').value = campaign.tittle || '';
          document.getElementById('shortDescription').value = campaign.description || '';
          document.getElementById('goalAmount').value = campaign.goal_amount || '';
          document.getElementById('mainImageUrl').value = campaign.main_image_url || '';
          
          if (campaign.expiration_date) {
            document.getElementById('expirationDate').value = campaign.expiration_date;
          }
          
          if (campaign.category_id) {
            document.getElementById('categorySelect').value = campaign.category_id;
          }
          
          // Cargar rich text en Quill
          if (campaign.rich_text) {
            quill.root.innerHTML = campaign.rich_text;
          }

          editingCampaignId = campaignId;
        } else {
          showError('No se pudo cargar la campaña');
        }
      } catch (error) {
        console.error('Error cargando campaña:', error);
        showError('Error al cargar los datos de la campaña');
      }
    }

    // Renderizar rewards
    function renderRewards() {
      const container = document.getElementById('rewardsList');
      container.innerHTML = rewards.map((r, i) => `
        <div class="reward-card">
          <div class="reward-info">
            <strong>${r.title}</strong> - Mínimo: $${r.minAmount}
            <p>${r.description}</p>
          </div>
          <button type="button" class="btn-remove" onclick="removeReward(${i})">
            <i class="fa-solid fa-trash"></i>
          </button>
        </div>
      `).join('');
    }

    // Añadir reward
    function addReward() {
      const title = document.getElementById('rewardTitle').value.trim();
      const minAmount = document.getElementById('rewardMinAmount').value;
      const description = document.getElementById('rewardDescription').value.trim();

      if (!title || !minAmount) {
        showError('Ingresa título y monto mínimo para la recompensa');
        return;
      }

      rewards.push({ title, minAmount: parseFloat(minAmount), description });
      renderRewards();
      hideMessages();

      document.getElementById('rewardTitle').value = '';
      document.getElementById('rewardMinAmount').value = '';
      document.getElementById('rewardDescription').value = '';
    }

    // Remover reward
    function removeReward(index) {
      rewards.splice(index, 1);
      renderRewards();
    }

    document.addEventListener('DOMContentLoaded', async function() {
      await loadCategories();
      
      // Verificar si estamos en modo edición
      const campaignId = getCampaignId();
      if (campaignId) {
        await loadCampaignData(campaignId);
      }

      // Event listeners para el modal de media
      document.getElementById('closeMediaModal').addEventListener('click', closeMediaModal);
      document.getElementById('cancelMediaBtn').addEventListener('click', closeMediaModal);
      document.getElementById('insertMediaBtn').addEventListener('click', insertMedia);
      
      // Cerrar modal con Escape o click fuera
      document.getElementById('mediaModal').addEventListener('click', function(e) {
        if (e.target === this) closeMediaModal();
      });
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') closeMediaModal();
      });
      
      // Enter en el input inserta el media
      document.getElementById('mediaUrlInput').addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          insertMedia();
        }
      });

      document.getElementById('btnAddReward').addEventListener('click', addReward);

      document.getElementById('btnCancel').addEventListener('click', function() {
        window.location.href = 'my-campaigns.html';
      });

      document.getElementById('btnSave').addEventListener('click', function() {
        saveCampaign(false);
      });

      document.getElementById('btnSendCampaign').addEventListener('click', function() {
        saveCampaign(true);
      });

      document.getElementById('btnObservations').addEventListener('click', function() {
        showError('Las observaciones estarán disponibles después de enviar la campaña para revisión.');
      });
    });

    async function saveCampaign(send) {
      hideMessages();
      
      const token = localStorage.getItem('token');
      if (!token) {
        window.location.href = 'login.html';
        return;
      }

      const tittle = document.getElementById('campaignTitle').value.trim();
      const description = document.getElementById('shortDescription').value.trim();
      const categoryId = document.getElementById('categorySelect').value;
      const goalAmount = document.getElementById('goalAmount').value;
      const expirationDate = document.getElementById('expirationDate').value;
      const mainImageUrl = document.getElementById('mainImageUrl').value.trim();
      const richText = quill.root.innerHTML;

      // Validación
      if (!tittle) {
        showError('El título de la campaña es obligatorio');
        return;
      }
      if (!description) {
        showError('La descripción corta es obligatoria');
        return;
      }
      if (!categoryId) {
        showError('Selecciona una categoría');
        return;
      }
      if (!goalAmount || parseFloat(goalAmount) <= 0) {
        showError('Ingresa una meta de financiación válida');
        return;
      }
      if (!expirationDate) {
        showError('Selecciona una fecha de expiración');
        return;
      }

      // Datos con los nombres correctos del backend
      const data = {
        tittle: tittle,
        description: description,
        goal_amount: parseFloat(goalAmount),
        expiration_date: expirationDate,
        main_image_url: mainImageUrl || null,
        rich_text: richText,
        category_id: parseInt(categoryId)
      };

      try {
        let response;
        
        if (editingCampaignId) {
          // Modo edición: PUT
          response = await fetch(`${API_URL}/campaigns/${editingCampaignId}`, {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify(data)
          });
        } else {
          // Modo creación: POST
          response = await fetch(`${API_URL}/campaigns/`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify(data)
          });
        }

        if (response.ok) {
          const msg = editingCampaignId 
            ? '¡Campaña actualizada exitosamente!' 
            : (send ? '¡Campaña creada!' : '¡Borrador guardado!');
          showSuccess(msg);
          setTimeout(() => {
            window.location.href = 'my-campaigns.html';
          }, 1500);
        } else {
          const err = await response.json();
          if (err.detail && Array.isArray(err.detail)) {
            const messages = err.detail.map(e => e.msg || e.message || 'Error de validación').join(', ');
            showError(messages);
          } else {
            showError(err.detail || 'Error al guardar la campaña');
          }
        }
      } catch (error) {
        console.error('Error:', error);
        showError('Error de conexión con el servidor');
      }
    }
  </script>
</body>
</html>