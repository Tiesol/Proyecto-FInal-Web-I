<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="../assets/css/style.css" />
  <link rel="stylesheet" href="../assets/css/normalize.css" />
  <link rel="stylesheet" href="../assets/css/header.css" />
  <link rel="stylesheet" href="../assets/css/hero.css">
  <link rel="stylesheet" href="../assets/css/featured_campaigns.css">
  <link rel="stylesheet" href="../assets/css/campaigns.css">
  <link rel="stylesheet" href="../assets/css/footer.css">
  <link rel="stylesheet" href="../assets/fontsawesome/css/solid.min.css" />
  <link rel="stylesheet" href="../assets/fontsawesome/css/fontawesome.min.css" />
  <link rel="stylesheet" href="../assets/fontsawesome/css/brands.min.css" />
  <title>RiseUp - Inicio</title>
</head>

<body>
  <header>
    <div class="logo_container">
      <a href="./index-logged.html">
        <img src="./../assets/images/riseup.svg" alt="Logo RiseUp" />
      </a>
    </div>

    <div class="search_container">
      <form action="#" method="post">
        <input type="search" name="search" placeholder="Buscar..." />
        <button type="submit">
          <i class="fa-solid fa-magnifying-glass"></i>
        </button>
      </form>
      <div class="search_dropdown">
        <div class="search_dropdown_title">Categorías</div>
        <div class="search_categories_grid" id="searchCategoriesGrid">
          <!-- Se cargan dinámicamente -->
        </div>
      </div>
    </div>

    <div class="user_menu_container">
      <input type="checkbox" id="userMenuToggle" class="user_menu_toggle">
      <label for="userMenuToggle" class="user_avatar_btn">
        <i class="fa-solid fa-user"></i>
      </label>
      <div class="user_dropdown">
        <a href="./my-campaigns.html" class="dropdown_item">
          <i class="fa-solid fa-bullhorn"></i>
          Mis Campañas
        </a>
        <a href="./favorites.html" class="dropdown_item">
          <i class="fa-solid fa-heart"></i>
          Favoritos
        </a>
        <a href="./donations.html" class="dropdown_item">
          <i class="fa-solid fa-hand-holding-dollar"></i>
          Mis Contribuciones
        </a>
        <a href="./profile.html" class="dropdown_item">
          <i class="fa-solid fa-user-circle"></i>
          Mi Perfil
        </a>
        <div class="dropdown_divider"></div>
        <a href="./admin.html" class="dropdown_item admin" id="adminLink" style="display: none;">
          <i class="fa-solid fa-shield"></i>
          Admin
        </a>
        <a href="#" class="dropdown_item logout" id="logoutBtn">
          <i class="fa-solid fa-right-from-bracket"></i>
          Cerrar Sesión
        </a>
      </div>
    </div>
  </header>

  <main>
    <!-- Hero Section -->
    <section class="hero">
      <div class="hero_content">
        <div>
          <h1 class="hero_title">Convierte Tus Ideas en Realidad</h1>
          <p class="hero_description">
            RiseUp es una plataforma de financiación colectiva que conecta visionarios, creadores y organizaciones con
            una comunidad dispuesta a apoyar proyectos innovadores. Aquí, las ideas cobran vida gracias al poder de
            muchas personas que creen en ellas.
          </p>
          <div class="hero_buttons">
            <a href="#campaigns" class="btn_primary">Explorar Campañas</a>
            <a href="#how-it-works" class="btn_secondary">Cómo Funciona</a>
            <a href="./faq.html" class="btn_faq_hero">Ver Preguntas Frecuentes</a>
          </div>
        </div>

        <div class="hero_cards">
          <div class="card">
            <i class="fa-solid fa-rocket"></i>
            <span>Lanza Proyectos</span>
          </div>
          <div class="card">
            <i class="fa-solid fa-users"></i>
            <span>Construye Comunidad</span>
          </div>
          <div class="card">
            <i class="fa-solid fa-trophy"></i>
            <span>Alcanza Metas</span>
          </div>
        </div>
      </div>
    </section>

    <!-- How It Works -->
    <section class="how_it_works" id="how-it-works">
      <h2 class="section_title">Cómo Funciona</h2>
      <p class="section_subtitle">
        Los creadores publican sus proyectos con una meta de financiación y un plazo determinado. Los usuarios pueden
        explorar, evaluar y contribuir a los proyectos que les resulten atractivos. Solo cuando se alcanza la meta
        establecida, los fondos se liberan al creador del proyecto.
      </p>

      <div class="steps_container">
        <div class="step">
          <div class="step_icon">
            <i class="fa-solid fa-lightbulb"></i>
          </div>
          <h3>1. Crea Tu Proyecto</h3>
          <p>Comparte tu visión, establece tu meta y cuenta tu historia para inspirar a los patrocinadores.</p>
        </div>

        <div class="step">
          <div class="step_icon">
            <i class="fa-solid fa-bullhorn"></i>
          </div>
          <h3>2. Corre La Voz</h3>
          <p>Promociona tu campaña y construye una comunidad alrededor de tu idea.</p>
        </div>

        <div class="step">
          <div class="step_icon">
            <i class="fa-solid fa-hand-holding-dollar"></i>
          </div>
          <h3>3. Obtén Financiación</h3>
          <p>Recibe contribuciones de seguidores que creen en tu proyecto.</p>
        </div>

        <div class="step">
          <div class="step_icon">
            <i class="fa-solid fa-check-circle"></i>
          </div>
          <h3>4. Hazlo Realidad</h3>
          <p>Una vez financiado, da vida a tu proyecto y cumple con tu promesa.</p>
        </div>
      </div>
    </section>

    <!-- Featured Carousel -->
    <section class="featured_campaigns" id="campaigns">
      <div class="featured_campaigns_header">
        <h2 class="section_title">Campañas Destacadas</h2>
        <p class="section_subtitle">Descubre los proyectos más destacados de nuestra comunidad</p>
      </div>

      <div class="carousel_container">
        <div class="carousel_wrapper">
          <a href="#" class="carousel_nav carousel_nav_prev">
            <i class="fa-solid fa-chevron-left"></i> Anterior
          </a>
          <a href="#" class="carousel_nav carousel_nav_next">
            Siguiente <i class="fa-solid fa-chevron-right"></i>
          </a>

          <div class="carousel_track">
            <!-- Campañas destacadas se cargan dinámicamente -->
          </div>

          <div class="carousel_indicators">
            <!-- Indicadores se generan dinámicamente -->
          </div>
        </div>
      </div>
    </section>

    <!-- Popular Campaigns -->
    <section class="popular_campaigns">
      <div class="popular_campaigns_header">
        <h2 class="section_title">Campañas Populares</h2>
        <p class="section_subtitle">Proyectos que están marcando la diferencia</p>
      </div>

      <div class="campaigns_grid">
        <!-- Campañas se cargan dinámicamente -->
      </div>
    </section>
  </main>

  <footer class="site_footer">
    <div class="footer_container">
      <div class="footer_brand">
        <img src="./../assets/images/riseup.svg" alt="RiseUp Logo" class="footer_logo">
        <p class="footer_description">Conectando ideas innovadoras con personas que creen en ellas.</p>
        <div class="footer_social">
          <a href="#" class="social_link" aria-label="Instagram"><i class="fa-brands fa-instagram"></i></a>
          <a href="#" class="social_link" aria-label="X"><i class="fa-brands fa-x-twitter"></i></a>
          <a href="#" class="social_link" aria-label="Facebook"><i class="fa-brands fa-facebook"></i></a>
          <a href="#" class="social_link" aria-label="GitHub"><i class="fa-brands fa-github"></i></a>
        </div>
      </div>

      <div class="footer_section">
        <h3 class="footer_title">Legal</h3>
        <ul class="footer_links">
          <li><a href="#">Términos y condiciones</a></li>
          <li><a href="#">Política de privacidad</a></li>
        </ul>
      </div>

      <div class="footer_section">
        <h3 class="footer_title">Soporte</h3>
        <ul class="footer_links">
          <li><a href="#">Centro de ayuda</a></li>
          <li><a href="#">Guías para creadores</a></li>
          <li><a href="mailto:soporte@riseup.com">soporte@riseup.com</a></li>
        </ul>
      </div>
    </div>

    <div class="footer_bottom">
      <p>&copy; 2025 RiseUp. Todos los derechos reservados.</p>
    </div>
  </footer>

  <!-- Script para cargar campañas dinámicamente -->
  <script>
    const API_URL = 'http://localhost:3000';

    // Verificar autenticación
    function isAuthenticated() {
      return !!localStorage.getItem('token');
    }

    function getCurrentUser() {
      const userStr = localStorage.getItem('user');
      return userStr ? JSON.parse(userStr) : null;
    }

    function logout() {
      localStorage.removeItem('token');
      localStorage.removeItem('user');
      window.location.href = './login.html';
    }

    // Proteger página
    if (!isAuthenticated()) {
      window.location.href = './login.html';
    }

    // Iconos para cada categoría
    const categoryIcons = {
      'Tecnología': 'fa-microchip',
      'Arte': 'fa-palette',
      'Música': 'fa-music',
      'Cine y Video': 'fa-film',
      'Juegos': 'fa-gamepad',
      'Diseño': 'fa-pen-ruler',
      'Fotografía': 'fa-camera',
      'Moda': 'fa-shirt',
      'Comida': 'fa-utensils',
      'Causas Sociales': 'fa-hand-holding-heart',
      'Educación': 'fa-graduation-cap',
      'Medio Ambiente': 'fa-leaf'
    };

    // Cargar categorías en el dropdown de búsqueda
    async function loadSearchCategories() {
      const grid = document.getElementById('searchCategoriesGrid');
      if (!grid) return;

      try {
        const response = await fetch(`${API_URL}/categories/`);
        if (!response.ok) throw new Error('Error al cargar categorías');
        
        const categories = await response.json();
        
        grid.innerHTML = categories.map(cat => `
          <a href="./category-logged.html?category=${cat.id}" class="search_category_card">
            <i class="fa-solid ${categoryIcons[cat.name] || 'fa-folder'}"></i>
            <span>${cat.name}</span>
          </a>
        `).join('');
        
        // Configurar dropdown y búsqueda
        setupSearchDropdownAndForm();
      } catch (error) {
        console.error('Error cargando categorías:', error);
      }
    }
    
    // Configurar dropdown de búsqueda y form
    function setupSearchDropdownAndForm() {
      const searchInput = document.querySelector('.search_container input');
      const searchDropdown = document.querySelector('.search_dropdown');
      const searchForm = document.querySelector('.search_container form');
      
      if (searchInput && searchDropdown) {
        searchInput.addEventListener('focus', () => {
          searchDropdown.classList.add('show');
        });
        
        document.addEventListener('click', (e) => {
          const searchContainer = document.querySelector('.search_container');
          if (searchContainer && !searchContainer.contains(e.target)) {
            searchDropdown.classList.remove('show');
          }
        });
      }
      
      if (searchForm) {
        searchForm.addEventListener('submit', (e) => {
          e.preventDefault();
          const query = searchInput.value.trim();
          if (query) {
            window.location.href = `./category-logged.html?search=${encodeURIComponent(query)}`;
          }
        });
      }
    }

    // Función para calcular días restantes
    function calculateDaysLeft(expirationDate) {
      if (!expirationDate) return 0;
      const today = new Date();
      const expDate = new Date(expirationDate);
      const diffTime = expDate - today;
      const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
      return diffDays > 0 ? diffDays : 0;
    }

    // Función para formatear moneda
    function formatCurrency(amount) {
      return new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD',
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
      }).format(amount);
    }

    // Función para crear card de campaña en el grid
    function createCampaignCard(campaign) {
      const daysLeft = calculateDaysLeft(campaign.expiration_date);
      const progress = campaign.progress_percentage || 0;
      
      return `
        <article class="campaign_grid_card">
          <div class="campaign_grid_image">
            <img src="${campaign.main_image_url || 'https://placehold.co/400x250/FF7A59/FFFFFF?text=Sin+Imagen'}" alt="${campaign.tittle}">
            <span class="campaign_category">${campaign.category_name || 'General'}</span>
          </div>
          <div class="campaign_grid_content">
            <div class="campaign_grid_user">
              <div class="grid_user_avatar">
                ${campaign.user_profile_image_url 
                  ? `<img src="${campaign.user_profile_image_url}" alt="${campaign.user_first_name}">` 
                  : '<i class="fa-solid fa-user"></i>'}
              </div>
              <span class="grid_user_name">${campaign.user_first_name} ${campaign.user_last_name}</span>
            </div>
            <h3 class="campaign_grid_title">${campaign.tittle}</h3>
            <div class="campaign_grid_progress">
              <div class="grid_progress_bar">
                <div class="grid_progress_fill" style="width: ${Math.min(progress, 100)}%"></div>
              </div>
              <p class="grid_progress_text">${formatCurrency(campaign.current_amount)} de ${formatCurrency(campaign.goal_amount)} | ${progress.toFixed(0)}% financiado</p>
            </div>
            <div class="campaign_grid_footer">
              <span class="grid_days_left">
                <i class="fa-solid fa-clock"></i> ${daysLeft} días restantes
              </span>
              <a href="campaign-detail-logged.html?id=${campaign.id}" class="btn_more_details">Ver más</a>
            </div>
          </div>
        </article>
      `;
    }

    // Función para crear card del carrusel
    function createCarouselCard(campaign) {
      const progress = campaign.progress_percentage || 0;
      
      return `
        <div class="campaign_card">
          <img src="${campaign.main_image_url || 'https://placehold.co/1200x600/FF7A59/FFFFFF?text=Sin+Imagen'}" alt="${campaign.tittle}" class="campaign_bg">
          <div class="campaign_overlay">
            <div class="campaign_content">
              <div class="user_info">
                <div class="user_avatar">
                  ${campaign.user_profile_image_url 
                    ? `<img src="${campaign.user_profile_image_url}" alt="${campaign.user_first_name}">` 
                    : '<i class="fa-solid fa-user"></i>'}
                </div>
                <span class="user_name">${campaign.user_first_name} ${campaign.user_last_name}</span>
              </div>
              <h3 class="campaign_title">${campaign.tittle}</h3>
              <div class="campaign_progress">
                <div class="progress_bar">
                  <div class="progress_fill" style="width: ${Math.min(progress, 100)}%"></div>
                </div>
                <div class="progress_info">
                  <span class="progress_percentage">${progress.toFixed(0)}%</span>
                  <span class="progress_funded">${formatCurrency(campaign.current_amount)} de ${formatCurrency(campaign.goal_amount)}</span>
                </div>
                <a href="campaign-detail-logged.html?id=${campaign.id}" class="btn_view_campaign">Ver Campaña</a>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    // Cargar campañas del carrusel (destacadas)
    async function loadFeaturedCampaigns() {
      const carouselTrack = document.querySelector('.carousel_track');
      const indicatorsContainer = document.querySelector('.carousel_indicators');
      
      try {
        const response = await fetch(`${API_URL}/campaigns/featured?limit=5`);
        const campaigns = await response.json();
        
        if (campaigns.length === 0) {
          carouselTrack.innerHTML = '<p style="text-align:center; padding: 2rem;">No hay campañas destacadas.</p>';
          return;
        }
        
        // Renderizar cards
        carouselTrack.innerHTML = campaigns.map(campaign => createCarouselCard(campaign)).join('');
        
        // Crear indicadores
        indicatorsContainer.innerHTML = campaigns.map((_, index) => 
          `<button class="indicator ${index === 0 ? 'active' : ''}" data-slide="${index}"></button>`
        ).join('');
        
        // Inicializar carrusel
        initCarousel(campaigns.length);
        
      } catch (error) {
        console.error('Error cargando campañas destacadas:', error);
        carouselTrack.innerHTML = '<p style="text-align:center; padding: 2rem; color: red;">Error al cargar campañas.</p>';
      }
    }

    // Cargar campañas populares (grid)
    async function loadPopularCampaigns() {
      const campaignsGrid = document.querySelector('.campaigns_grid');
      
      // Mostrar loading
      campaignsGrid.innerHTML = `
        <div class="loading_campaigns">
          <i class="fa-solid fa-spinner fa-spin"></i>
          <p>Cargando campañas...</p>
        </div>
      `;
      
      try {
        const response = await fetch(`${API_URL}/campaigns/public?limit=6`);
        const campaigns = await response.json();
        
        if (campaigns.length === 0) {
          campaignsGrid.innerHTML = `
            <div class="no_campaigns">
              <i class="fa-solid fa-folder-open"></i>
              <p>No hay campañas disponibles.</p>
            </div>
          `;
          return;
        }
        
        // Renderizar campañas
        campaignsGrid.innerHTML = campaigns.map(campaign => createCampaignCard(campaign)).join('');
        
      } catch (error) {
        console.error('Error cargando campañas:', error);
        campaignsGrid.innerHTML = `
          <div class="error_campaigns">
            <i class="fa-solid fa-exclamation-triangle"></i>
            <p>Error al cargar las campañas.</p>
          </div>
        `;
      }
    }

    // Inicializar carrusel
    function initCarousel(totalSlides) {
      let currentSlide = 0;
      const cards = document.querySelectorAll('.carousel_track .campaign_card');
      const indicators = document.querySelectorAll('.indicator');
      const prevBtn = document.querySelector('.carousel_nav_prev');
      const nextBtn = document.querySelector('.carousel_nav_next');
      
      function updateCarousel() {
        cards.forEach((card, index) => {
          card.style.display = index === currentSlide ? 'block' : 'none';
        });
        indicators.forEach((ind, index) => {
          ind.classList.toggle('active', index === currentSlide);
        });
      }
      
      if (prevBtn) {
        prevBtn.addEventListener('click', (e) => {
          e.preventDefault();
          currentSlide = (currentSlide - 1 + totalSlides) % totalSlides;
          updateCarousel();
        });
      }
      
      if (nextBtn) {
        nextBtn.addEventListener('click', (e) => {
          e.preventDefault();
          currentSlide = (currentSlide + 1) % totalSlides;
          updateCarousel();
        });
      }
      
      indicators.forEach((indicator, index) => {
        indicator.addEventListener('click', () => {
          currentSlide = index;
          updateCarousel();
        });
      });
      
      // Auto-play
      setInterval(() => {
        currentSlide = (currentSlide + 1) % totalSlides;
        updateCarousel();
      }, 5000);
      
      updateCarousel();
    }

    // Configurar UI de usuario
    window.onload = function() {
      // Cargar campañas y categorías
      loadFeaturedCampaigns();
      loadPopularCampaigns();
      loadSearchCategories();
      
      // Configurar admin link y logout
      const user = getCurrentUser();
      const adminLink = document.getElementById('adminLink');
      const logoutBtn = document.getElementById('logoutBtn');
      
      if (user && user.role_id === 1 && adminLink) {
        adminLink.style.display = 'flex';
      }
      
      if (logoutBtn) {
        logoutBtn.addEventListener('click', function(e) {
          e.preventDefault();
          logout();
        });
      }
    };
  </script>
  <script src="../js/search-categories.js"></script>
  <script src="../js/header-user.js"></script>
</body>
</html>