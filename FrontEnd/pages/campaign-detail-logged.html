<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="../assets/css/style.css" />
  <link rel="stylesheet" href="../assets/css/normalize.css" />
  <link rel="stylesheet" href="../assets/css/header.css" />
  <link rel="stylesheet" href="../assets/css/campaign-detail.css" />
  <link rel="stylesheet" href="../assets/css/donators.css" />
  <link rel="stylesheet" href="../assets/css/rewards.css" />
  <link rel="stylesheet" href="../assets/css/description.css" />
  <link rel="stylesheet" href="../assets/css/footer.css" />
  <link rel="stylesheet" href="../assets/fontsawesome/css/solid.min.css" />
  <link rel="stylesheet" href="../assets/fontsawesome/css/fontawesome.min.css" />
  <link rel="stylesheet" href="../assets/fontsawesome/css/brands.min.css" />
  <link rel="icon" href="../assets/images/riseup.svg" type="image/svg+xml">
  <title>Aplicación Móvil Innovadora - RiseUp</title>
</head>

<body>
  <header>
    <div class="logo_container">
      <a href="./index-logged.html">
        <img src="./../assets/images/riseup.svg" alt="Logo RiseUp" />
      </a>
    </div>

    <div class="search_container">
      <form action="#" method="post">
        <input type="search" name="search" placeholder="Buscar..." />
        <button type="submit">
          <i class="fa-solid fa-magnifying-glass"></i>
        </button>
      </form>
      <div class="search_dropdown">
        <div class="search_dropdown_title">Categorías</div>
        <div class="search_categories_grid" id="searchCategoriesGrid"></div>
      </div>
    </div>

    <div class="user_menu_container">
      <input type="checkbox" id="userMenuToggle" class="user_menu_toggle">
      <label for="userMenuToggle" class="user_avatar_btn">
        <i class="fa-solid fa-user"></i>
      </label>
      <div class="user_dropdown">
        <a href="./my-campaigns.html" class="dropdown_item">
          <i class="fa-solid fa-bullhorn"></i>
          Mis Campañas
        </a>
        <a href="./favorites.html" class="dropdown_item">
          <i class="fa-solid fa-heart"></i>
          Favoritos
        </a>
        <a href="./donations.html" class="dropdown_item">
          <i class="fa-solid fa-hand-holding-dollar"></i>
          Mis Contribuciones
        </a>
        <a href="./profile.html" class="dropdown_item">
          <i class="fa-solid fa-user-circle"></i>
          Mi Perfil
        </a>
        <div class="dropdown_divider"></div>
        <a href="./admin.html" class="dropdown_item admin" id="adminLink" style="display: none;">
          <i class="fa-solid fa-shield"></i>
          Admin
        </a>
        <a href="#" class="dropdown_item logout" id="logoutBtn">
          <i class="fa-solid fa-right-from-bracket"></i>
          Cerrar Sesión
        </a>
      </div>
    </div>
  </header>

  <main class="campaign_detail_main">
  <div class="campaign_detail_container">
    
    <section class="campaign_hero">
      <div class="campaign_hero_left">
        <div class="loading_placeholder" style="width: 100%; height: 400px; background: #e0e0e0; display: flex; align-items: center; justify-content: center;">
          <i class="fa-solid fa-spinner fa-spin" style="font-size: 2rem; color: #999;"></i>
        </div>
        <img src="" alt="Campaña" style="display: none;">
      </div>
      
      <div class="campaign_hero_right">
        <div class="campaign_info_card">
          <div class="creator_info">
            <div class="creator_avatar">
              <i class="fa-solid fa-user"></i>
            </div>
            <span class="creator_name">Cargando...</span>
          </div>

          <h1 class="campaign_detail_title">Cargando...</h1>

          <p class="campaign_short_description">
            Cargando descripción...
          </p>

          <div class="campaign_detail_progress">
            <div class="detail_progress_bar">
              <div class="detail_progress_fill" style="width: 0%"></div>
            </div>
            <p class="funding_text">Cargando...</p>
          </div>

          <button class="btn_donate">DONAR</button>

          <a href="#" class="add_favorite">
            <i class="fa-regular fa-bookmark"></i>
            Agregar a favoritos
          </a>
        </div>
      </div>
    </section>

    <section class="top_donators_section">
      <h2 class="section_title_detail">
        <i class="fa-solid fa-trophy"></i>
        Top Donadores
      </h2>
      <div class="donators_list">
        <p style="text-align: center; color: #666; padding: 1rem;"><i class="fa-solid fa-spinner fa-spin"></i> Cargando donadores...</p>
      </div>
    </section>

    <section class="rewards_section">
      <h2 class="section_title_detail">
        <i class="fa-solid fa-gift"></i>
        Recompensas
      </h2>
      <div class="rewards_grid">
        <p style="grid-column: 1/-1; text-align: center; color: #666; padding: 1rem;"><i class="fa-solid fa-spinner fa-spin"></i> Cargando recompensas...</p>
      </div>
    </section>

    <section class="full_description_section">
      <h2 class="section_title_detail">
        <i class="fa-solid fa-file-lines"></i>
        Descripción Completa
      </h2>
      <div class="description_content">
        <p style="text-align: center; color: #666;"><i class="fa-solid fa-spinner fa-spin"></i> Cargando descripción...</p>
      </div>
    </section>

  </div>
</main>

  <footer class="site_footer">
  <div class="footer_container">
    <div class="footer_section footer_brand">
      <img src="./../assets/images/riseup.svg" alt="RiseUp Logo" class="footer_logo">
      <p class="footer_description">
        Conectando ideas innovadoras con personas que creen en ellas.
      </p>
      <div class="footer_social">
        <a href="#" aria-label="Instagram" class="social_link">
          <i class="fa-brands fa-instagram"></i>
        </a>
        <a href="#" aria-label="X (Twitter)" class="social_link">
          <i class="fa-brands fa-x-twitter"></i>
        </a>
        <a href="#" aria-label="Facebook" class="social_link">
          <i class="fa-brands fa-facebook"></i>
        </a>
        <a href="#" aria-label="GitHub" class="social_link">
          <i class="fa-brands fa-github"></i>
        </a>
      </div>
    </div>

    <div class="footer_section">
      <h3 class="footer_title">Legal</h3>
      <ul class="footer_links">
        <li><a href="#">Términos y condiciones</a></li>
        <li><a href="#">Política de privacidad</a></li>
      </ul>
    </div>

    <div class="footer_section">
      <h3 class="footer_title">Soporte</h3>
      <ul class="footer_links">
        <li><a href="#">Centro de ayuda</a></li>
        <li><a href="#">Guías para creadores</a></li>
        <li><a href="mailto:soporte@riseup.com">soporte@riseup.com</a></li>
      </ul>
    </div>
  </div>

  <div class="footer_bottom">
    <p>&copy; 2025 RiseUp. Todos los derechos reservados.</p>
  </div>
</footer>

<script>
  const API_URL = 'http://localhost:3000';

  // Verificar autenticación
  function isAuthenticated() {
    return !!localStorage.getItem('token');
  }

  function getToken() {
    return localStorage.getItem('token');
  }

  function getCurrentUser() {
    const userStr = localStorage.getItem('user');
    return userStr ? JSON.parse(userStr) : null;
  }

  function logout() {
    localStorage.removeItem('token');
    localStorage.removeItem('user');
    window.location.href = './login.html';
  }

  // Proteger página
  if (!isAuthenticated()) {
    window.location.href = './login.html';
  }

  // Obtener ID de campaña de la URL
  function getCampaignId() {
    const params = new URLSearchParams(window.location.search);
    return params.get('id');
  }

  // Formatear moneda
  function formatCurrency(amount) {
    return new Intl.NumberFormat('en-US', {
      style: 'currency',
      currency: 'USD',
      minimumFractionDigits: 0,
      maximumFractionDigits: 0
    }).format(amount);
  }

  // Calcular días restantes
  function calculateDaysLeft(expirationDate) {
    if (!expirationDate) return 0;
    const today = new Date();
    const expDate = new Date(expirationDate);
    const diffTime = expDate - today;
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    return diffDays > 0 ? diffDays : 0;
  }

  // Variable global para la campaña
  let currentCampaign = null;
  let isFavorite = false;

  // Cargar detalle de la campaña
  async function loadCampaignDetail() {
    const campaignId = getCampaignId();
    const token = localStorage.getItem('token');
    
    if (!campaignId) {
      window.location.href = './index-logged.html';
      return;
    }

    try {
      // Primero intentar con endpoint autenticado (para ver propias campañas en borrador)
      let response;
      if (token) {
        response = await fetch(`${API_URL}/campaigns/${campaignId}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
      }
      
      // Si falla o no hay token, intentar endpoint público
      if (!response || !response.ok) {
        response = await fetch(`${API_URL}/campaigns/public/${campaignId}`);
      }
      
      if (!response.ok) {
        throw new Error('Campaña no encontrada');
      }
      
      currentCampaign = await response.json();
      renderCampaignDetail(currentCampaign);
      
    } catch (error) {
      console.error('Error cargando campaña:', error);
      window.location.href = './index-logged.html';
    }
  }

  // Renderizar detalle de la campaña
  function renderCampaignDetail(campaign) {
    // Ocultar placeholder y mostrar imagen
    const loadingPlaceholder = document.querySelector('.loading_placeholder');
    const heroImage = document.querySelector('.campaign_hero_left img');
    
    if (loadingPlaceholder) {
      loadingPlaceholder.style.display = 'none';
    }
    
    heroImage.src = campaign.main_image_url || 'https://placehold.co/800x500/FF7A59/FFFFFF?text=Sin+Imagen';
    heroImage.alt = campaign.tittle;
    heroImage.style.display = 'block';

    // Nombre del creador
    const creatorName = campaign.user_first_name 
      ? `${campaign.user_first_name} ${campaign.user_last_name || ''}`
      : 'Creador';
    document.querySelector('.creator_name').textContent = creatorName;

    // Imagen del creador
    const creatorAvatar = document.querySelector('.creator_avatar');
    if (campaign.user_profile_image_url) {
      creatorAvatar.innerHTML = `<img src="${campaign.user_profile_image_url}" alt="${campaign.user_first_name || 'Creador'}">`;
    }

    // Título
    document.querySelector('.campaign_detail_title').textContent = campaign.tittle;

    // Descripción corta
    document.querySelector('.campaign_short_description').textContent = campaign.description || 'Sin descripción disponible';

    // Progreso
    const progress = campaign.goal_amount > 0 
      ? (campaign.current_amount / campaign.goal_amount * 100) 
      : 0;
    
    document.querySelector('.detail_progress_fill').style.width = `${Math.min(progress, 100)}%`;
    document.querySelector('.funding_text').textContent = 
      `${formatCurrency(campaign.current_amount)} de ${formatCurrency(campaign.goal_amount)} | ${progress.toFixed(0)}% financiado`;

    // Descripción completa (rich_text)
    const descriptionContent = document.querySelector('.description_content');
    if (campaign.rich_text) {
      descriptionContent.innerHTML = campaign.rich_text;
    } else {
      descriptionContent.innerHTML = `
        <h3>Sobre el Proyecto</h3>
        <p>${campaign.description || 'Sin descripción disponible'}</p>
      `;
    }

    // Actualizar título de la página
    document.title = `${campaign.tittle} - RiseUp`;
  }

  // Cargar recompensas
  async function loadRewards() {
    const campaignId = getCampaignId();
    if (!campaignId) return;

    try {
      const response = await fetch(`${API_URL}/rewards/campaign/${campaignId}`);
      const rewards = await response.json();
      renderRewards(rewards);
    } catch (error) {
      console.error('Error cargando recompensas:', error);
    }
  }

  // Renderizar recompensas
  function renderRewards(rewards) {
    const rewardsGrid = document.querySelector('.rewards_grid');
    
    if (!rewards || rewards.length === 0) {
      rewardsGrid.innerHTML = '<p style="grid-column: 1/-1; text-align: center; color: #666;">Esta campaña aún no tiene recompensas.</p>';
      return;
    }

    rewardsGrid.innerHTML = rewards.map(reward => `
      <div class="reward_card">
        <h3 class="reward_title">${reward.tittle}</h3>
        <div class="reward_image">
          <img src="${reward.image_url || 'https://placehold.co/300x200/FF7A59/FFFFFF?text=Recompensa'}" alt="${reward.tittle}">
        </div>
        <p class="reward_amount">${formatCurrency(reward.amount)}</p>
        <p class="reward_description">${reward.description || 'Sin descripción'}</p>
        ${reward.stock !== null ? `<p class="reward_stock">Disponibles: ${reward.stock}</p>` : ''}
      </div>
    `).join('');
  }

  // Cargar top donadores
  async function loadTopDonors() {
    const campaignId = getCampaignId();
    if (!campaignId) return;

    try {
      const response = await fetch(`${API_URL}/donations/campaign/${campaignId}/top-donors?limit=5`);
      const donors = await response.json();
      renderTopDonors(donors);
    } catch (error) {
      console.error('Error cargando donadores:', error);
    }
  }

  // Renderizar top donadores
  function renderTopDonors(donors) {
    const donatorsList = document.querySelector('.donators_list');
    
    if (!donors || donors.length === 0) {
      donatorsList.innerHTML = '<p style="text-align: center; color: #666; padding: 1rem;">Sé el primero en donar a esta campaña.</p>';
      return;
    }

    donatorsList.innerHTML = donors.map(donor => `
      <div class="donator_item">
        <div class="donator_info">
          <div class="donator_avatar">
            <i class="fa-solid fa-user"></i>
          </div>
          <span class="donator_name">${donor.user_name}</span>
        </div>
        <span class="donator_amount">${formatCurrency(donor.amount)}</span>
      </div>
    `).join('');
  }

  // Mostrar mensaje temporal (reemplaza alerts)
  function showMessage(message, isError = false) {
    // Remover mensaje anterior si existe
    const existingMsg = document.querySelector('.temp_message');
    if (existingMsg) existingMsg.remove();

    const msgDiv = document.createElement('div');
    msgDiv.className = 'temp_message';
    msgDiv.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 1rem 1.5rem;
      border-radius: 8px;
      background: ${isError ? '#ef4444' : '#22c55e'};
      color: white;
      font-weight: 500;
      z-index: 9999;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    `;
    msgDiv.textContent = message;
    document.body.appendChild(msgDiv);

    setTimeout(() => msgDiv.remove(), 3000);
  }

  // Manejar donación
  async function handleDonate() {
    const campaignId = getCampaignId();
    const amount = prompt('¿Cuánto deseas donar? (USD)');
    
    if (!amount || isNaN(amount) || parseFloat(amount) <= 0) {
      return;
    }

    try {
      const response = await fetch(`${API_URL}/donations/`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${getToken()}`
        },
        body: JSON.stringify({
          campaign_id: parseInt(campaignId),
          amount: parseFloat(amount),
          payment_method_id: 1
        })
      });

      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.detail || 'Error al procesar donación');
      }

      showMessage('¡Donación realizada con éxito! Gracias por tu apoyo.');
      loadCampaignDetail();
      loadTopDonors();

    } catch (error) {
      console.error('Error:', error);
      showMessage(error.message, true);
    }
  }

  // Manejar favoritos
  async function handleFavorite(e) {
    e.preventDefault();
    const campaignId = getCampaignId();
    const favoriteBtn = document.querySelector('.add_favorite');
    const icon = favoriteBtn.querySelector('i');

    try {
      const response = await fetch(`${API_URL}/favorites/`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${getToken()}`
        },
        body: JSON.stringify({
          campaign_id: parseInt(campaignId)
        })
      });

      if (response.ok) {
        isFavorite = true;
        icon.classList.remove('fa-regular');
        icon.classList.add('fa-solid');
        favoriteBtn.style.color = '#FF7A59';
        favoriteBtn.innerHTML = '<i class="fa-solid fa-bookmark"></i> En favoritos';
      } else {
        const error = await response.json();
        // Si ya está en favoritos, mostrar como tal
        if (error.detail && error.detail.includes('ya')) {
          isFavorite = true;
          icon.classList.remove('fa-regular');
          icon.classList.add('fa-solid');
          favoriteBtn.style.color = '#FF7A59';
          favoriteBtn.innerHTML = '<i class="fa-solid fa-bookmark"></i> En favoritos';
        }
      }

    } catch (error) {
      console.error('Error:', error);
    }
  }

  // Inicializar página
  window.onload = function() {
    loadCampaignDetail();
    loadRewards();
    loadTopDonors();

    // Configurar botón de donar
    const donateBtn = document.querySelector('.btn_donate');
    donateBtn.addEventListener('click', handleDonate);

    // Configurar favoritos
    const favoriteBtn = document.querySelector('.add_favorite');
    favoriteBtn.addEventListener('click', handleFavorite);

    // Configurar admin link y logout
    const user = getCurrentUser();
    const adminLink = document.getElementById('adminLink');
    const logoutBtn = document.getElementById('logoutBtn');

    if (user && user.role_id === 1 && adminLink) {
      adminLink.style.display = 'flex';
    }

    if (logoutBtn) {
      logoutBtn.addEventListener('click', function(e) {
        e.preventDefault();
        logout();
      });
    }
  };
</script>
<script src="../js/search-categories.js"></script>
<script src="../js/header-user.js"></script>
</body>
</html>